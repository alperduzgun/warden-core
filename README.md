# Warden Core - The AI Code Guardian

> "AI writes the code. Warden guards the production."

![Status](https://img.shields.io/badge/Status-Production%20Ready-success)
![Python](https://img.shields.io/badge/Python-3.9%2B-blue)
![AI Ready](https://img.shields.io/badge/AI-Native-purple)

**Warden** is an AI-native security and quality gate designed to validate code generated by LLMs (Claude, GPT-4, etc.) before it enters your codebase. It acts as a strict, impartial judge enforcing architectural rules, preventing security vulnerabilities, and maintaining code hygiene.

---

## ü§ñ Why Warden?

AI coding assistants are powerful but prone to:
*   **Hallucinations:** Inventing non-existent APIs or libraries.
*   **Subtle Bugs:** Introducing edge cases that human reviewers miss.
*   **Security Flaws:** Hardcoding secrets or using unsafe patterns.
*   **Drift:** Deviating from established project architecture.

Warden provides the **"Verify-Loop"** mechanism to ensure every AI-generated change is validated against a rigorous set of rules.

---

## üöÄ Core Features

### 1. üß† AI-Native Integration (MCP & Hooks)
Warden is built to integrate directly with your AI Agent:
*   **Context Loading:** Automatically injects `.warden/AI_RULES.md` into every session via Claude `SessionStart` hooks.
*   **Protocol Enforcement:** Instructs AI agents to follow the **Plan -> Execute -> Verify** loop.
*   **Feedback Loop:** Provides JSON/SARIF reports that AI agents can read to self-correct.

### 2. üõ°Ô∏è The 6-Frame Validation Pipeline
Warden runs your code through 6 specialized "Frames":
1.  **SecurityFrame (Critical):** Detects SQLi, XSS, and hardcoded secrets.
2.  **ChaosEngineeringFrame (High):** Validates error handling and resilience patterns.
3.  **FuzzTestingFrame (High):** Checks for type safety and edge case handling.
4.  **PropertyTestingFrame (Medium):** Verifies idempotency and invariants.
5.  **ArchitecturalConsistencyFrame (Medium):** Enforces SOLID principles and file limits.
6.  **StressTestingFrame (Low):** Identifies performance bottlenecks (N+1 queries).

### üß© Frames Concept: Not Just Plugins
Frames in Warden are more than just plugins; they are **Intelligence Adapters**.
*   **The Problem:** Tools like `ruff`, `mypy`, or `security-scanner-x` are dumb execution engines. They don't know your business context or architecture.
*   **The Warden Frame:** Acts as a "Driver" that:
    1.  **Orchestrates:** Runs the tool across all applicable phases (Pre-Check, Metrics, Validation).
    2.  **Translates:** Converts raw JSON/CLI output into rich `Warden Findings`.
    3.  **Contextualizes:** Decides if a finding matters based on your Project Purpose (e.g., "Ignore strict type checks in prototypes").
    *   *Note: Frames rely on the tools being installed in your environment (e.g., via `pip` or `npm`), ensuring strictly safe, non-invasive operation.*

### 3. ‚ú® Warden Craftsman (New!)
Warden doesn't just find bugs; it acts as a **Senior Software Craftsman**. The Cleaning Phase (`code-simplifier`) analyzes your code for:
*   **Elegance:** Simplifying nested logic and removing redundant variables.
*   **Clarity:** Reducing cognitive load and improving readability.
*   **Modernization:** Suggesting modern language features (e.g., Python `f-strings`, `list comprehensions`).

*Try it yourself:*
```bash
warden scan examples/messy_code.py
```

### 4. üö¶ False Positive Management
Warden gives you granular control over what to check:
*   **Inline Suppression:** Use `# warden-ignore: rule-id` to suppress specific issues.
*   **Global Config:** Define suppressions in `.warden/suppressions.yaml`.
*   **File Exclusion:** Respects `.gitignore` and supports `.warden/ignore.yaml`.

### 5. üß† Structural Intelligence & Hygiene (New!)
Warden goes beyond code syntax; it understands your **Project Architecture**:
*   **Anomaly Detection:** Uses AI to identify structural flaws (e.g., redundant configuration files, orphaned directories) that static analysis misses.
*   **Smart Hygiene:** Automatically filters noise (`__pycache__`, `node_modules`) globally, ensuring AI focuses only on relevant code.
*   **One-Config Standard:** Enforces a single source of truth (`.warden/config.yaml`), preventing "Config Drift".

### 6. üß† Dynamic AI-Powered Rules (New!)
Warden reaches beyond static analysis patterns:
*   **Pure AI Rules:** Define rules using human language directives (e.g., "Check for race conditions in async loops"). No regex required.
*   **Context-Aware Loading:** Rules automatically activate based on your project's framework (FastAPI, React, etc.) and project type (Microservice, Library).
*   **Deep Logic Auditing:** Detects complex flaws like synchronization issues, circular dependencies, and resilience pattern violations.

### 7. üß† Hallucination Prevention (Suppression System)
AI analysis can sometimes produce "hallucinations" ‚Äì findings that look like issues but are actually valid code patterns (false positives). Warden provides a dedicated **Suppression Phase** to filter these out.

**How it works:**
1.  **Generation:** Frames analyze code and may generate false positives (e.g., `stress-unclosed_file` on a managed stream).
2.  **Filtration:** Before reporting, Warden checks `.warden/rules/suppressions.yaml`.
3.  **Suppression:** If a finding matches a suppression rule, it is silently removed from the report.

**Configuration (`.warden/rules/suppressions.yaml`):**
```yaml
enabled: true
entries:
  - id: "suppress-stress-fp"        # Unique ID for the rule
    rules:
      - "stress-unclosed_file"      # The Finding ID to suppress (e.g. hallucination)
    file: "src/utils/stream.py"     # Specific file path
    reason: "Standard streams are managed by system"
```
> **Note:** Unlike `CustomRule`s which are *active* checks, Suppressions are *passive* filters that run at the very end of the pipeline.

### 8. üõ°Ô∏è Hybrid Analysis (Verification Phase)
Warden reduces false positives by implementing a "Trust but Verify" approach:
1.  **Fast Scan:** Static analysis (Regex/LSP) quickly identifies potential issues.
2.  **LLM Judge:** A specialized prompt acts as a "Senior Security Engineer", reviewing the finding against the code context.
3.  **Result:**
    -   **True Positives:** Passed to Fortification for fixing.
    -   **False Positives:** (e.g., Type Hints mistaken for arrays) are silently filtered out BEFORE consuming tokens on auto-fix generation.


---

## üèÅ Quick Start

### Installation

```bash
pip install warden-core
```

### Initialization (The Critical Step)

To setup Warden for your project and **configure your AI Agent**:

```bash
warden init --agent
```

This command:
1.  Analyzes your project structure.
2.  Creates `.warden/AI_RULES.md`.
3.  Configures Claude Code hooks (`.claude/settings.json`) to auto-load rules.
4.  Sets up MCP configuration.
5.  Creates `.env` and `.env.example` for your API keys.

### The "Verify-Loop" Protocol

AI Agents working in a Warden project follow this strict protocol:

1.  **PLAN:** Design the change (Task or Phase).
2.  **EXECUTE:** Implement the code.
3.  **VERIFY:** Run `warden scan` at the end of the task/phase.
    *   **IF PASS:** Display **Quality Score (X/10)** üöÄ
    *   **IF FAIL:** Fix issues and Repeat.

---

## üõ†Ô∏è Command Reference

| Command | Description |
| :--- | :--- |
| `warden scan` | Runs the full validation pipeline on the project. |
| `warden validate <file>` | Scans a single file for immediate feedback. |
| `warden serve` | Starts the MCP Server for AI integration. |
| `warden doctor` | Checks project health and configuration status. |
| `warden install` | Installs/Updates validation frames. |
| `warden search <query>` | Searches Warden Hub or local codebase. |

---

## üìÇ Project Structure

```
.
‚îú‚îÄ‚îÄ .warden/
‚îÇ   ‚îú‚îÄ‚îÄ AI_RULES.md          # Protocol for AI Agents
‚îÇ   ‚îú‚îÄ‚îÄ config.yaml          # Pipeline configuration
‚îÇ   ‚îú‚îÄ‚îÄ ignore.yaml          # File exclusions
‚îÇ   ‚îî‚îÄ‚îÄ rules/               # Custom rules & Suppressions
‚îÇ       ‚îú‚îÄ‚îÄ suppressions.yaml # False positive rules
‚îÇ       ‚îú‚îÄ‚îÄ ai_rules.yaml    # AI-powered logic rules
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ reports/             # Scan results (JSON, SARIF)
‚îú‚îÄ‚îÄ .claude/
‚îÇ   ‚îî‚îÄ‚îÄ settings.json        # Hooks for auto-loading context
‚îî‚îÄ‚îÄ src/                     # Your source code
```

---

## üß© Architecture

Warden is designed with modular "Frames" and extends easily:

*   **Pipes & Filters:** Sequential execution pipeline.
*   **Priority Groups:** Critical security checks run first (Fail-Fast).
*   **LSP Synergy:** Uses Language Server Protocol for deep code understanding.
*   **Vector Search & Memory:** Semantic search for context-aware fixes and specialized "Project Purpose" memory.

### üèÜ The Hybrid Guardian Identity

Warden stands out by being a **Hybrid Architecture Guardian**. Unlike cloud-only review bots that rely heavily on PR context and SaaS infrastructure, Warden is designed as a **Privacy-First, Local-First** sentinel.

| Feature | ‚òÅÔ∏è Traditional Cloud Bot | üõ°Ô∏è Warden Core (The Guardian) |
| :--- | :--- | :--- |
| **Execution** | Cloud SaaS Only | **Local + CI/CD + Cloud** |
| **Privacy** | Code leaves your machine | **100% Local Processing** (LLM is optional/configurable) |
| **Context** | Pull Request & Tickets | **Project Purpose & Architecture Graph** |
| **Deep Scan** | Full Sandbox Build | **Dependency Graph & Impact Analysis** |
| **Memory** | Vector DB (SaaS) | **Local Vector DB + Knowledge Graph** |
| **Cost** | Per-Token / User | **Optimized (Qwen Fast Tier + Deterministic Rules First)** |

#### üîë Key Differentiators

1.  **Project Purpose Detector (Intent Analysis):**
    Typical cloud bots deduce intent from Jira/Linear tickets. Warden deduces it **directly from your code**. It analyzes your codebase to understand if it's a "Crypto Wallet" or "E-Commerce API" and adjusts its rules accordingly.

2.  **Architectural Frames:**
    We don't just look for bugs. We look for **Architectural Crimes**.
    *   *Did the Domain layer import Infrastructure?*
    *   *Is the code strictly following Clean Architecture?*
    *   *Are we drifting from the established design patterns?*

3.  **Active Memory (The "Brain"):**
    Warden doesn't just scan; it **remembers**.
    *   **Semantic Hashing:** Ignores whitespace/comment changes to avoid re-scanning.
    *   **Knowledge Graph:** Stores "Facts" about your project (e.g., "This project uses `pydantic` v2").
    *   **Vector Search:** (Roadmap) Retrieving similar historical code blocks to guide valid fixes.

#### üß¨ Anatomy of the Guardian

*   **üß† The Brain (Project Context):** Does not just lint; it *understands* (e.g., "This is a Crypto Wallet, so security is paramount").
*   **üëÄ The Eyes (DependencyGraph):** Sees the "Butterfly Effect" ‚Äî how a change in `utils.py` breaks `api.py`.
*   **üìö The Memory (Vector DB):** Recalls historical context and similar code patterns (Active Retrieval capabilities).
*   **‚ö° The Reflexes (Semantic Hashing):** Ignores noise (whitespace, comments) to focus purely on meaningful logic.

> **The Philosophy:** Warden is not a "Reviewer" that you wait for; it is a **Guardian** that stands at the gate of your repo, ensuring quality *before* commitment.

---

## üìÑ License

[License Info]
