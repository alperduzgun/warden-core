#!/usr/bin/env bash

# Warden CLI Wrapper with Self-Test
# Ensures CLI is working before running commands

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Resolve symlinks to find real script location
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$( readlink "$SOURCE" )"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

# Find CLI and .env paths
CLI_DIR="$SCRIPT_DIR/.."
CLI_JS="$CLI_DIR/dist/cli.js"
PROJECT_ROOT="$( cd "$CLI_DIR/.." && pwd )"
ENV_FILE="$PROJECT_ROOT/.env"
TEST_MARKER="$CLI_DIR/.test-passed"

# Check if running in CI or with bypass flag
SKIP_TESTS="${WARDEN_SKIP_TESTS:-false}"
IS_CI="${CI:-false}"

# Check if running help/version commands (no tests needed)
for arg in "$@"; do
  case $arg in
    --help|-h|--version|-v|help)
      SKIP_TESTS="true"
      break
      ;;
  esac
done

# Function to check if tests passed recently (within 1 hour)
tests_passed_recently() {
  if [ ! -f "$TEST_MARKER" ]; then
    return 1
  fi

  # Get file modification time in seconds since epoch
  if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    FILE_TIME=$(stat -f %m "$TEST_MARKER" 2>/dev/null || echo 0)
  else
    # Linux
    FILE_TIME=$(stat -c %Y "$TEST_MARKER" 2>/dev/null || echo 0)
  fi

  CURRENT_TIME=$(date +%s)
  TIME_DIFF=$((CURRENT_TIME - FILE_TIME))

  # Check if less than 1 hour (3600 seconds)
  if [ $TIME_DIFF -lt 3600 ]; then
    return 0
  else
    return 1
  fi
}

# Function to run quick self-test
run_self_test() {
  echo -e "${BLUE}ğŸ” Checking CLI status...${NC}"

  # Quick test - check if status command works
  # Strip ANSI escape sequences from output before checking
  TEST_OUTPUT=$(timeout 10 node "$CLI_JS" status 2>&1 | sed 's/\x1b\[[0-9;]*m//g')

  if [ $? -eq 0 ] && echo "$TEST_OUTPUT" | grep -qi "pong"; then
    echo -e "${GREEN}âœ… CLI is ready${NC}"
    # Mark test as passed
    date +%s > "$TEST_MARKER"
    return 0
  else
    # Backend might not be running, try to start it
    echo -e "${YELLOW}âš¡ Starting backend service...${NC}"

    # Kill any existing backend processes first
    pkill -f "python.*server.py" 2>/dev/null || true

    # Wait a moment
    sleep 1

    # Start backend in background
    BACKEND_SCRIPT="$PROJECT_ROOT/src/warden/cli_bridge/server.py"
    if [ -f "$BACKEND_SCRIPT" ]; then
      # Create a log file for debugging
      BACKEND_LOG="/tmp/warden-backend.log"

      echo -e "${BLUE}Starting backend service (this may take a few seconds)...${NC}"

      # Start backend with proper environment and logging (use subshell to preserve current directory)
      (cd "$PROJECT_ROOT" && python3 "$BACKEND_SCRIPT" --transport socket >"$BACKEND_LOG" 2>&1) &

      BACKEND_PID=$!

      # Wait for backend to start (max 15 seconds)
      echo -ne "${YELLOW}Waiting for backend"
      for i in {1..30}; do
        echo -ne "."
        sleep 0.5

        # Check if backend process is still running
        if ! kill -0 $BACKEND_PID 2>/dev/null; then
          echo -e "\n${RED}Backend process died. Check log: $BACKEND_LOG${NC}"
          tail -5 "$BACKEND_LOG" 2>/dev/null
          return 1
        fi

        # Try to connect to backend
        # Strip ANSI escape sequences from output before checking
        TEST_OUTPUT=$(timeout 2 node "$CLI_JS" status 2>&1 | sed 's/\x1b\[[0-9;]*m//g')

        if [ $? -eq 0 ] && echo "$TEST_OUTPUT" | grep -qi "pong"; then
          echo -e "\n${GREEN}âœ… Backend started successfully${NC}"
          date +%s > "$TEST_MARKER"
          return 0
        fi
      done

      echo -e "\n${YELLOW}Backend is taking longer than expected. Last log entries:${NC}"
      tail -5 "$BACKEND_LOG" 2>/dev/null
    else
      echo -e "${RED}Backend script not found: $BACKEND_SCRIPT${NC}"
    fi

    echo -e "${RED}âŒ Could not start backend automatically${NC}"
    return 1
  fi
}

# Check if CLI is built
if [ ! -f "$CLI_JS" ]; then
  echo -e "${RED}âŒ CLI not built. Run 'npm run build' in the cli directory.${NC}"
  exit 1
fi

# Skip tests if requested or CI environment
if [ "$SKIP_TESTS" = "true" ] || [ "$IS_CI" = "true" ]; then
  # Run CLI directly
  exec node "$CLI_JS" "$@"
fi

# Check if tests passed recently
if tests_passed_recently; then
  # Tests passed recently, run CLI directly
  exec node "$CLI_JS" "$@"
fi

# Run self-test
if run_self_test; then
  # Test passed, run CLI
  exec node "$CLI_JS" "$@"
else
  # Test failed
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${RED}âš ï¸  Unable to start Warden CLI${NC}"
  echo ""
  echo -e "${YELLOW}Possible issues:${NC}"
  echo "  â€¢ Python 3 is not installed"
  echo "  â€¢ Missing dependencies"
  echo "  â€¢ Permission issues"
  echo ""
  echo -e "${BLUE}Please try:${NC}"
  echo "  1. Ensure Python 3 is installed: python3 --version"
  echo "  2. Reinstall CLI: cd $CLI_DIR && npm install && npm run build"
  echo "  3. Check permissions: ls -la $PROJECT_ROOT/src/warden/cli_bridge/server.py"
  echo ""
  echo -e "${YELLOW}For manual start:${NC}"
  echo "  python3 $PROJECT_ROOT/src/warden/cli_bridge/server.py --transport socket"
  echo ""
  echo -e "${YELLOW}To bypass (temporary):${NC}"
  echo "  WARDEN_SKIP_TESTS=true warden-cli [command]"
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  exit 1
fi
