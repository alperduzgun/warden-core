#!/usr/bin/env python3
"""
Warden pre-commit hook.

This hook runs Warden analysis on staged files before allowing a commit.
Auto-generated by Warden Infrastructure Module.
"""

import subprocess
import sys
from pathlib import Path


def get_staged_files() -> list[str]:
    """Get list of staged Python files."""
    result = subprocess.run(
        ["git", "diff", "--cached", "--name-only", "--diff-filter=ACM"],
        capture_output=True,
        text=True,
        check=False,
    )

    if result.returncode != 0:
        return []

    files = result.stdout.strip().split("\n")
    # Filter Python files
    python_files = [f for f in files if f.endswith(".py") and Path(f).exists()]

    return python_files


def main() -> int:
    """Run Warden analysis on staged files."""
    print("ğŸ›¡ï¸  Running Warden pre-commit checks...")

    staged_files = get_staged_files()

    if not staged_files:
        print("âœ“ No Python files staged, skipping Warden analysis.")
        return 0

    print(f"Analyzing {len(staged_files)} staged file(s)...")

    # Run Warden on staged files
    cmd = [
        "warden",
        "analyze",
        "--frame", "security",
        "--frame", "fuzz",
        "--ci",
    ] + staged_files

    result = subprocess.run(cmd, capture_output=True, text=True, check=False)

    if result.returncode != 0:
        print("âŒ Warden found issues in staged files:")
        print(result.stdout)
        print("\nCommit blocked. Fix issues or use 'git commit --no-verify' to bypass.")
        return 1

    print("âœ“ Warden pre-commit checks passed!")
    return 0


if __name__ == "__main__":
    sys.exit(main())
