name: Warden CI

on:
  push:
    branches: [ main, dev ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ============================================================
  # LINT JOB - Fast feedback on code style
  # ============================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    # Lint now blocks CI to enforce code quality
    continue-on-error: false

    steps:
      - name: Free Disk Space (Manual)
        run: |
          echo "Freeing disk space..."
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/powershell
          echo "Disk space freed."

      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Ruff
        run: pip install ruff==0.15.0

      - name: Run Ruff Linter
        run: ruff check src/ --output-format=github
        continue-on-error: false

      - name: Run Ruff Formatter Check
        run: |
          echo "Running ruff format check..."
          ruff format src/ --check --diff || {
            echo "‚ùå Formatting issues found. Files that need formatting:"
            ruff format src/ --check 2>&1 | grep "would be reformatted" || true
            exit 1
          }
        continue-on-error: false

  # ============================================================
  # TEST JOB - Matrix testing across Python versions
  # ============================================================
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    # Do NOT run the full test matrix on release tags; keep it for PRs/branch pushes
    if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src/warden_rust
          shared-key: "rust-py${{ matrix.python-version }}"

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install ".[dev]"

      - name: Run Tests
        run: |
          # Test exclusions (VALID for CI):
          # --ignore=tests/chaos/ - Requires Hypothesis (optional dependency)
          # --ignore=tests/integration/ - Requires external services (Ollama, APIs)
          # --ignore=tests/e2e/test_acceptance.py - Subprocess tests with different Ollama setup
          # -m "not requires_ollama" - Skip tests needing local Ollama
          pytest tests/ -v --tb=short -x \
            --ignore=tests/chaos/ \
            --ignore=tests/integration/ \
            --ignore=tests/e2e/test_acceptance.py \
            -m "not requires_ollama" \
            -q

  # ============================================================
  # WARDEN SCAN JOB - Security analysis
  # ============================================================
  warden-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [lint]
    if: always() && needs.lint.result == 'success'

    steps:
      - name: Free Disk Space (Manual)
        run: |
          echo "Freeing disk space..."
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/powershell
          echo "Disk space freed."

      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      # Rust is pre-installed on ubuntu-latest. We only cache the artifacts.
      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src/warden_rust
          shared-key: "rust-warden-scan"

      # Removed apt-get install as build-essential is pre-installed on ubuntu-latest
      # and it saves ~1-2 minutes of setup time.

      - name: Install Warden
        run: |
          pip install --upgrade pip
          pip install .
          # Verify installation
          warden --help

      - name: Cache Warden Storage
        uses: actions/cache@v5
        with:
          path: |
            .warden/memory
            .warden/embeddings
          key: warden-storage-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            warden-storage-${{ runner.os }}-

      - name: Cache AI Models
        uses: actions/cache@v5
        with:
          path: ~/.ollama
          key: ollama-models-${{ runner.os }}-${{ hashFiles('.warden/config.yaml') }}
          restore-keys: |
            ollama-models-${{ runner.os }}-

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Cache Baseline Report
        id: baseline-cache
        uses: actions/cache@v5
        with:
          path: .warden/baseline.sarif
          key: warden-baseline-${{ github.ref_name }}-${{ hashFiles('.warden/config.yaml') }}
          restore-keys: |
            warden-baseline-${{ github.ref_name }}-
            warden-baseline-main-

      - name: Verify Code Intelligence (Audit Context)
        env:
          WARDEN_LLM_PROVIDER: "groq"
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          WARDEN_BLOCKED_PROVIDERS: "claude_code,codex"
        run: |
          echo "Generating Code Intelligence and Context Graphs..."
          warden refresh --force

          echo "Checking for structural gaps (Broken Imports, Unreachable Code, Circular Docs)..."
          warden audit-context --check


      - name: Run Warden Scan
        env:
          # Configuration for Hybrid LLM Architecture
          # Smart Tier: Groq (fast cloud API, no token cost issues)
          # Fast/Local Tier: Ollama qwen2.5-coder:3b (free, local fallback)

          # Secrets
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

          # Warden Configuration
          WARDEN_LLM_PROVIDER: "groq"         # Smart Tier: Groq (overrides config.yaml's claude_code)
          WARDEN_FAST_TIER_PRIORITY: "ollama"  # Fast/Local Tier: Ollama qwen2.5-coder:3b
          WARDEN_LLM_CONCURRENCY: "5"          # Conservative for Groq rate limits

          # Local Service Config
          OLLAMA_HOST: http://localhost:11434

          # Git ref for incremental scan (env var to prevent script injection)
          BASE_REF: ${{ github.base_ref || 'main' }}
        run: |
          # --- OLLAMA SETUP ---
          # We run this here to ensure the background process persists for the scan duration.

          echo "Installing Ollama (Official Script)..."
          # Download and verify before executing
          curl -fsSL -o /tmp/ollama-install.sh https://ollama.com/install.sh
          bash /tmp/ollama-install.sh
          rm /tmp/ollama-install.sh
          
          # The install script starts a systemd service as 'ollama' user.
          # We must stop it to run our own instance as 'runner' user (to see the cache).
          sudo systemctl stop ollama || true
          sudo systemctl disable ollama || true
          
          echo "Debug: Checking Cache Content..."
          ls -la ~/.ollama || echo "No .ollama directory found"
          
          echo "Starting Local Ollama Server..."
          ollama serve &
          
          echo "Waiting for Ollama service..."
          for i in {1..30}; do
            if curl -s http://localhost:11434/api/tags > /dev/null; then
              echo "Ollama service is ready!"
              break
            fi
            sleep 1
          done
          if ! curl -s http://localhost:11434/api/tags > /dev/null; then
            echo "::warning::Ollama failed to start, continuing without local LLM"
            export OLLAMA_UNAVAILABLE=true
          fi
          
          echo "Checking for existing models..."
          ollama list # Verify models visible to the server
          if ollama list | grep -q "qwen2.5-coder:3b"; then
            echo "‚úÖ Model qwen2.5-coder:3b already cached."
          else
            echo "‚¨áÔ∏è Model not found in cache. Pulling..."
            ollama pull qwen2.5-coder:3b
          fi
          
          # --- SCAN EXECUTION ---
          
          # Determine scan strategy: Baseline (first run) or Incremental (subsequent runs)
          if [[ -f ".warden/baseline.sarif" ]]; then
            echo "‚úÖ Baseline found - Running INCREMENTAL SCAN"
            SCAN_MODE="incremental"
          else
            echo "üîç No baseline found - Running FULL DEEP SCAN to establish baseline"
            SCAN_MODE="baseline"
          fi
          
          LEVEL="standard"
          
          if [[ "$SCAN_MODE" == "baseline" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # BASELINE SCAN: Standard scan (deep would load broken custom frames)
            echo "Running FULL SCAN on entire repository..."
            set +e # Capture exit code
            warden scan . --level standard --format sarif --output warden.sarif
            EXIT_CODE=$?
            set -e
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Scan passed successfully."
            elif [ $EXIT_CODE -eq 2 ]; then
              echo "üö´ SCANNED FAILED: CRITICAL ISSUES FOUND"
              echo "::error title=Policy Violation::Critical issues were found in the codebase. Please review the SARIF report."
              exit 1
            else
              # Runtime errors (LLM unavailable, timeout, etc.) are infrastructure issues.
              # They should not block CI ‚Äî code quality is separate from LLM availability.
              echo "::warning title=Scan Incomplete::Warden scan could not complete (LLM unavailable or timeout). Quality gate skipped."
              echo "‚ö†Ô∏è Scan infrastructure failure (exit $EXIT_CODE) ‚Äî not a code quality violation."
            fi

            # Save as baseline for future incremental scans (only if sarif was generated)
            if [ -f warden.sarif ]; then
              mkdir -p .warden
              cp warden.sarif .warden/baseline.sarif
              echo "üì¶ Baseline saved to .warden/baseline.sarif"
            fi
          else
            # INCREMENTAL SCAN: Only scan files changed in this push/PR
            echo "Running INCREMENTAL SCAN on changed files..."

            # 1. Fetch history to ensure diff works
            git fetch origin "$BASE_REF" --depth=1

            # 2. Get changed python files
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              CHANGED_FILES=$(git diff --name-only --diff-filter=d "origin/$BASE_REF"...HEAD | grep "\.py$" || true)
            else
              # For push to main/dev, check against previous commit
              CHANGED_FILES=$(git diff --name-only --diff-filter=d HEAD~1 HEAD | grep "\.py$" || true)
            fi

            echo "Changed files:"
            echo "$CHANGED_FILES"

            # 3. Run scan on changed files
            if [[ -z "$CHANGED_FILES" ]]; then
               echo "No Python files changed. Skipping scan."
               # Still output baseline as current report for consistency
               cp .warden/baseline.sarif warden.sarif
               exit 0
            fi

            set +e # Capture exit code
            # Flatten newlines to spaces for direct argument passing
            FILES=$(echo "$CHANGED_FILES" | tr '\n' ' ')
            warden scan $FILES --level $LEVEL --format sarif --output warden.sarif
            EXIT_CODE=$?
            set -e

            if [ $EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Scan passed successfully."
            elif [ $EXIT_CODE -eq 2 ]; then
              echo "üö´ SCANNED FAILED: CRITICAL ISSUES FOUND"
              echo "::error title=Policy Violation::Critical issues were found in the changed files. Please review the SARIF report."
              exit 1
            else
              # Runtime errors (LLM unavailable, timeout, etc.) are infrastructure issues.
              # They should not block CI ‚Äî code quality is separate from LLM availability.
              echo "::warning title=Scan Incomplete::Warden scan could not complete (LLM unavailable or timeout). Quality gate skipped."
              echo "‚ö†Ô∏è Scan infrastructure failure (exit $EXIT_CODE) ‚Äî not a code quality violation."
            fi
          fi

      - name: Archive SARIF Artifact
        uses: actions/upload-artifact@v6
        if: always() && hashFiles('warden.sarif') != ''
        with:
          name: warden-scan-results
          path: warden.sarif

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && github.event_name != 'pull_request' && hashFiles('warden.sarif') != ''
        with:
          sarif_file: warden.sarif
          category: warden-security

  # ============================================================
  # RELEASE SMOKE - Fast verification on release tags
  # ============================================================
  release-smoke:
    name: Release Smoke (fast)
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [lint]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dev Dependencies
        run: |
          pip install --upgrade pip
          pip install .[dev]

      - name: Pytest Smoke (minimal)
        env:
          WARDEN_NON_INTERACTIVE: "true"
          CORS_ORIGINS: "[]"
        run: |
          pytest -q -x \
            tests/e2e/test_cli_commands.py::TestGlobalCLI::test_help \
            tests/e2e/test_init_flows.py::TestInitFileCreation::test_init_creates_config_yaml \
            tests/e2e/test_llm_cli.py::test_init_help_shows_new_flags \
            tests/e2e/test_llm_cli.py::test_config_llm_help_and_status
