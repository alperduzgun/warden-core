name: Warden CI

on:
  push:
    branches: [ main, dev ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  warden-scan:
    name: Self-Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # Rust is pre-installed on ubuntu-latest. We only cache the artifacts.
      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src/warden_rust

      # Removed apt-get install as build-essential is pre-installed on ubuntu-latest
      # and it saves ~1-2 minutes of setup time.

      - name: Install Warden
        run: |
          pip install --upgrade pip
          pip install -e .
          # Verify installation
          warden --help

      - name: Cache Warden Storage
        uses: actions/cache@v4
        with:
          path: |
            .warden/memory
            .warden/embeddings
          key: warden-storage-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            warden-storage-${{ runner.os }}-

      - name: Cache AI Models
        uses: actions/cache@v4
        with:
          path: ~/.ollama
          key: ollama-models-${{ runner.os }}-${{ hashFiles('.warden/config.yaml') }}
          restore-keys: |
            ollama-models-${{ runner.os }}-

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Baseline Report
        id: baseline-cache
        uses: actions/cache@v4
        with:
          path: .warden/baseline.sarif
          key: warden-baseline-${{ github.ref_name }}-${{ hashFiles('.warden/config.yaml') }}
          restore-keys: |
            warden-baseline-${{ github.ref_name }}-

      - name: Run Warden Scan
        # continue-on-error removed to enforce quality gate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
          AZURE_OPENAI_DEPLOYMENT_NAME: ${{ secrets.AZURE_OPENAI_DEPLOYMENT_NAME }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          LLM_PROVIDER: ${{ secrets.LLM_PROVIDER }}
          DEFAULT_LLM_MODEL: ${{ secrets.DEFAULT_LLM_MODEL }}
          # Ensure Warden detects local Ollama
          OLLAMA_HOST: http://localhost:11434
        run: |
          # --- OLLAMA SETUP ---
          # We run this here to ensure the background process persists for the scan duration.
          
          echo "Installing Ollama..."
          curl -fsSL https://ollama.com/install.sh | sh
          
          echo "Starting Ollama Server..."
          ollama serve &
          
          echo "Waiting for Ollama service..."
          for i in {1..30}; do
            if curl -s http://localhost:11434/api/tags > /dev/null; then
              echo "Ollama service is ready!"
              break
            fi
            sleep 1
          done
          
          echo "Pulling qwen2.5-coder:0.5b..."
          ollama pull qwen2.5-coder:0.5b
          
          # --- SCAN EXECUTION ---
          
          # Determine scan strategy: Baseline (first run) or Incremental (subsequent runs)
          if [[ -f ".warden/baseline.sarif" ]]; then
            echo "‚úÖ Baseline found - Running INCREMENTAL SCAN"
            SCAN_MODE="incremental"
          else
            echo "üîç No baseline found - Running FULL DEEP SCAN to establish baseline"
            SCAN_MODE="baseline"
          fi
          
          LEVEL="standard"
          
          if [[ "$SCAN_MODE" == "baseline" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # BASELINE SCAN: Full deep scan of entire project
            echo "Running FULL SCAN on entire repository..."
            set +e # Capture exit code
            warden scan . --level deep --format sarif --output warden.sarif --verbose
            EXIT_CODE=$?
            set -e
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Scan passed successfully."
            elif [ $EXIT_CODE -eq 2 ]; then
              echo "üö´ SCANNED FAILED: CRITICAL ISSUES FOUND"
              echo "::error title=Policy Violation::Critical issues were found in the codebase. Please review the SARIF report."
              exit 1
            else
              echo "üí• SCANNED FAILED: RUNTIME ERROR"
              echo "::error title=System Error::Warden encountered an unexpected error."
              exit 1
            fi
            
            # Save as baseline for future incremental scans
            mkdir -p .warden
            cp warden.sarif .warden/baseline.sarif
            echo "üì¶ Baseline saved to .warden/baseline.sarif"
          else
            # INCREMENTAL SCAN: Only scan files changed in this push/PR
            echo "Running INCREMENTAL SCAN on changed files..."
            
            # 1. Fetch history to ensure diff works
            git fetch origin ${{ github.base_ref || 'main' }} --depth=1
            
            # 2. Get changed python files
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              CHANGED_FILES=$(git diff --name-only --diff-filter=d origin/${{ github.base_ref }}...HEAD | grep "\.py$" || true)
            else
              # For push to main/dev, check against previous commit
              CHANGED_FILES=$(git diff --name-only --diff-filter=d HEAD~1 HEAD | grep "\.py$" || true)
            fi

            echo "Changed files:"
            echo "$CHANGED_FILES"

            # 3. Run scan on changed files
            if [[ -z "$CHANGED_FILES" ]]; then
               echo "No Python files changed. Skipping scan."
               # Still output baseline as current report for consistency
               cp .warden/baseline.sarif warden.sarif
               exit 0
            fi
            
            set +e # Capture exit code
            echo "$CHANGED_FILES" | xargs warden scan --level $LEVEL --format sarif --output warden.sarif --verbose
            EXIT_CODE=$?
            set -e

            if [ $EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Scan passed successfully."
            elif [ $EXIT_CODE -eq 2 ]; then
              echo "üö´ SCANNED FAILED: CRITICAL ISSUES FOUND"
              echo "::error title=Policy Violation::Critical issues were found in the changed files. Please review the SARIF report."
              exit 1
            else
              echo "üí• SCANNED FAILED: RUNTIME ERROR"
              echo "::error title=System Error::Warden encountered an unexpected error."
              exit 1
            fi
          fi

      - name: Archive SARIF Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: warden-scan-results
          path: warden.sarif

