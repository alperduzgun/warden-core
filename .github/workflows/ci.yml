name: Warden CI

on:
  push:
    branches: [ main, dev ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  warden-scan:
    name: Self-Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # Rust is pre-installed on ubuntu-latest. We only cache the artifacts.
      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src/warden_rust

      # Removed apt-get install as build-essential is pre-installed on ubuntu-latest
      # and it saves ~1-2 minutes of setup time.

      - name: Install Warden
        run: |
          pip install --upgrade pip
          pip install -e .
          # Verify installation
          warden --help

      - name: Cache Warden Storage
        uses: actions/cache@v4
        with:
          path: |
            .warden/memory
            .warden/embeddings
          key: warden-storage-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            warden-storage-${{ runner.os }}-

      - name: Cache AI Models
        uses: actions/cache@v4
        with:
          path: ~/.ollama
          key: ollama-models-${{ runner.os }}-${{ hashFiles('.warden/config.yaml') }}
          restore-keys: |
            ollama-models-${{ runner.os }}-

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Warden Scan
        # continue-on-error removed to enforce quality gate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
          AZURE_OPENAI_DEPLOYMENT_NAME: ${{ secrets.AZURE_OPENAI_DEPLOYMENT_NAME }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          LLM_PROVIDER: ${{ secrets.LLM_PROVIDER }}
          DEFAULT_LLM_MODEL: ${{ secrets.DEFAULT_LLM_MODEL }}
          # Ensure Warden detects local Ollama
          OLLAMA_HOST: http://localhost:11434
        run: |
          # --- OLLAMA SETUP ---
          # We run this here to ensure the background process persists for the scan duration.
          
          echo "Installing Ollama..."
          curl -fsSL https://ollama.com/install.sh | sh
          
          echo "Starting Ollama Server..."
          ollama serve &
          
          echo "Waiting for Ollama service..."
          for i in {1..30}; do
            if curl -s http://localhost:11434/api/tags >/dev/null; then
              echo "Ollama service is ready!"
              break
            fi
            sleep 1
          done
          
          echo "Pulling qwen2.5-coder:0.5b..."
          ollama pull qwen2.5-coder:0.5b
          
          # --- SCAN EXECUTION ---
          
          # Layered Scan Strategy: 
          # - All Events: STANDARD (Full AI analysis with Local LLM)
          # We have optimized the CI to include Ollama and Qwen, so we use STANDARD
          # to ensure comprehensive validation even in PRs.
          
          LEVEL="standard"
          
          echo "Running Warden Scan with level: $LEVEL"
          
          # Smart Diff Scanning: Only scan files changed in this push/PR
          # This prevents re-scanning the entire codebase on every commit (which takes hours).
          
          # 1. Fetch history to ensure diff works
          git fetch origin ${{ github.base_ref || 'main' }} --depth=1
          
          # 2. Get changed python files
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED_FILES=$(git diff --name-only --diff-filter=d origin/${{ github.base_ref }}...HEAD | grep "\.py$" || true)
          else
            # For push to main/dev, check against previous commit
            CHANGED_FILES=$(git diff --name-only --diff-filter=d HEAD~1 HEAD | grep "\.py$" || true)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # 3. Running scan
          # If manually triggered (workflow_dispatch) via UI, assume FULL SCAN (.)
          # Otherwise, run incremental scan on CHANGED_FILES or full scan if no changes detected but requested.
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
             echo "Running FULL SCAN on entire repository (Manual Trigger)..."
             warden scan . --level $LEVEL --format sarif --output warden.sarif --verbose
          else
             # Incremental Mode for PR/Push
             if [[ -z "$CHANGED_FILES" ]]; then
                echo "No Python files changed. Skipping scan."
                exit 0
             fi
             echo "Running INCREMENTAL SCAN on changed files..."
             # Now warden scan accepts multiple arguments, so we can pass them directly via xargs (without -n1)
             echo "$CHANGED_FILES" | xargs warden scan --level $LEVEL --format sarif --output warden.sarif --verbose
          fi



      - name: Archive SARIF Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: warden-scan-results
          path: warden.sarif

