name: Warden CI

on:
  push:
    branches: [ main, dev ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ============================================================
  # LINT JOB - Fast feedback on code style
  # ============================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    # Lint now blocks CI to enforce code quality
    continue-on-error: false

    steps:
      - name: Free Disk Space (Manual)
        run: |
          echo "Freeing disk space..."
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/powershell
          echo "Disk space freed."

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ruff
        run: pip install ruff

      - name: Run Ruff Linter
        run: ruff check src/ --output-format=github
        continue-on-error: false

      - name: Run Ruff Formatter Check
        run: ruff format src/ --check --diff
        continue-on-error: false

  # ============================================================
  # TEST JOB - Matrix testing across Python versions
  # ============================================================
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src/warden_rust
          shared-key: "rust-py${{ matrix.python-version }}"

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install ".[dev]"

      - name: Run Tests
        run: |
          # Test exclusions (VALID for CI):
          # --ignore=tests/chaos/ - Requires Hypothesis (optional dependency)
          # --ignore=tests/integration/ - Requires external services (Ollama, APIs)
          pytest tests/ -v --tb=short -x --ignore=tests/chaos/ --ignore=tests/integration/ -q

  # ============================================================
  # WARDEN SCAN JOB - Security analysis
  # ============================================================
  warden-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [lint, test]  # Run after lint and test pass

    steps:
      - name: Free Disk Space (Manual)
        run: |
          echo "Freeing disk space..."
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/powershell
          echo "Disk space freed."

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # Rust is pre-installed on ubuntu-latest. We only cache the artifacts.
      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src/warden_rust
          shared-key: "rust-warden-scan"

      # Removed apt-get install as build-essential is pre-installed on ubuntu-latest
      # and it saves ~1-2 minutes of setup time.

      - name: Install Warden
        run: |
          pip install --upgrade pip
          pip install .
          # Verify installation
          warden --help

      - name: Cache Warden Storage
        uses: actions/cache@v5
        with:
          path: |
            .warden/memory
            .warden/embeddings
          key: warden-storage-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            warden-storage-${{ runner.os }}-

      - name: Cache AI Models
        uses: actions/cache@v5
        with:
          path: ~/.ollama
          key: ollama-models-${{ runner.os }}-${{ hashFiles('.warden/config.yaml') }}
          restore-keys: |
            ollama-models-${{ runner.os }}-

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Baseline Report
        id: baseline-cache
        uses: actions/cache@v5
        with:
          path: .warden/baseline.sarif
          key: warden-baseline-${{ github.ref_name }}-${{ hashFiles('.warden/config.yaml') }}
          restore-keys: |
            warden-baseline-${{ github.ref_name }}-

      - name: Run Warden Scan
        # continue-on-error removed to enforce quality gate
        env:
          # Configuration for Hybrid Fast Tier Architecture
          # 1. Smart Tier: Azure OpenAI
          # 2. Fast Tier Priority: Groq (Cloud/Fast) -> Ollama (Local/Free)

          # Secrets
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
          AZURE_OPENAI_DEPLOYMENT_NAME: ${{ secrets.AZURE_OPENAI_DEPLOYMENT_NAME }}

          # Warden Configuration
          WARDEN_LLM_PROVIDER: "azure_openai"       # Smart Tier
          WARDEN_FAST_TIER_PRIORITY: "groq,ollama"  # Fast Tier Chain
          WARDEN_LLM_CONCURRENCY: "10"              # Concurrency Limit

          # Local Service Config
          OLLAMA_HOST: http://localhost:11434

          # Git ref for incremental scan (env var to prevent script injection)
          BASE_REF: ${{ github.base_ref || 'main' }}
        run: |
          # --- OLLAMA SETUP ---
          # We run this here to ensure the background process persists for the scan duration.
          
          # We run this here to ensure the background process persists for the scan duration.
          
          echo "Installing Ollama (Official Script)..."
          # Download and verify before executing
          curl -fsSL -o /tmp/ollama-install.sh https://ollama.com/install.sh
          bash /tmp/ollama-install.sh
          rm /tmp/ollama-install.sh
          
          # The install script starts a systemd service as 'ollama' user.
          # We must stop it to run our own instance as 'runner' user (to see the cache).
          sudo systemctl stop ollama || true
          sudo systemctl disable ollama || true
          
          echo "Debug: Checking Cache Content..."
          ls -la ~/.ollama || echo "No .ollama directory found"
          
          echo "Starting Local Ollama Server..."
          ollama serve &
          
          echo "Waiting for Ollama service..."
          for i in {1..30}; do
            if curl -s http://localhost:11434/api/tags > /dev/null; then
              echo "Ollama service is ready!"
              break
            fi
            sleep 1
          done
          if ! curl -s http://localhost:11434/api/tags > /dev/null; then
            echo "::warning::Ollama failed to start, continuing without local LLM"
            export OLLAMA_UNAVAILABLE=true
          fi
          
          echo "Checking for existing models..."
          ollama list # Verify models visible to the server
          if ollama list | grep -q "qwen2.5-coder:0.5b"; then
            echo "‚úÖ Model qwen2.5-coder:0.5b already cached."
          else
            echo "‚¨áÔ∏è Model not found in cache. Pulling..."
            ollama pull qwen2.5-coder:0.5b
          fi
          
          # --- SCAN EXECUTION ---
          
          # Determine scan strategy: Baseline (first run) or Incremental (subsequent runs)
          if [[ -f ".warden/baseline.sarif" ]]; then
            echo "‚úÖ Baseline found - Running INCREMENTAL SCAN"
            SCAN_MODE="incremental"
          else
            echo "üîç No baseline found - Running FULL DEEP SCAN to establish baseline"
            SCAN_MODE="baseline"
          fi
          
          LEVEL="standard"
          
          if [[ "$SCAN_MODE" == "baseline" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # BASELINE SCAN: Full deep scan of entire project
            echo "Running FULL SCAN on entire repository..."
            set +e # Capture exit code
            warden scan . --level deep --format sarif --output warden.sarif
            EXIT_CODE=$?
            set -e
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Scan passed successfully."
            elif [ $EXIT_CODE -eq 2 ]; then
              echo "üö´ SCANNED FAILED: CRITICAL ISSUES FOUND"
              echo "::error title=Policy Violation::Critical issues were found in the codebase. Please review the SARIF report."
              exit 1
            else
              echo "üí• SCANNED FAILED: RUNTIME ERROR"
              echo "::error title=System Error::Warden encountered an unexpected error."
              exit 1
            fi
            
            # Save as baseline for future incremental scans
            mkdir -p .warden
            cp warden.sarif .warden/baseline.sarif
            echo "üì¶ Baseline saved to .warden/baseline.sarif"
          else
            # INCREMENTAL SCAN: Only scan files changed in this push/PR
            echo "Running INCREMENTAL SCAN on changed files..."
            
            # 1. Fetch history to ensure diff works
            git fetch origin "$BASE_REF" --depth=1

            # 2. Get changed python files
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              CHANGED_FILES=$(git diff --name-only --diff-filter=d "origin/$BASE_REF"...HEAD | grep "\.py$" || true)
            else
              # For push to main/dev, check against previous commit
              CHANGED_FILES=$(git diff --name-only --diff-filter=d HEAD~1 HEAD | grep "\.py$" || true)
            fi

            echo "Changed files:"
            echo "$CHANGED_FILES"

            # 3. Run scan on changed files
            if [[ -z "$CHANGED_FILES" ]]; then
               echo "No Python files changed. Skipping scan."
               # Still output baseline as current report for consistency
               cp .warden/baseline.sarif warden.sarif
               exit 0
            fi
            
            set +e # Capture exit code
            # Flatten newlines to spaces for direct argument passing
            FILES=$(echo "$CHANGED_FILES" | tr '\n' ' ')
            warden scan $FILES --level $LEVEL --format sarif --output warden.sarif
            EXIT_CODE=$?
            set -e

            if [ $EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Scan passed successfully."
            elif [ $EXIT_CODE -eq 2 ]; then
              echo "üö´ SCANNED FAILED: CRITICAL ISSUES FOUND"
              echo "::error title=Policy Violation::Critical issues were found in the changed files. Please review the SARIF report."
              exit 1
            else
              echo "üí• SCANNED FAILED: RUNTIME ERROR"
              echo "::error title=System Error::Warden encountered an unexpected error."
              exit 1
            fi
          fi

      - name: Archive SARIF Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: warden-scan-results
          path: warden.sarif

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && github.event_name != 'pull_request'
        with:
          sarif_file: warden.sarif
          category: warden-security

