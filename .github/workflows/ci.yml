name: Warden CI

on:
  push:
    branches: [ main, dev ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ============================================================
  # LINT JOB - Fast feedback on code style
  # ============================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    # Lint is advisory: failures surface as annotations and SARIF findings
    # but do NOT block the test matrix or security scan.
    continue-on-error: true

    steps:
      - name: Free Disk Space (Manual)
        run: |
          echo "Freeing disk space..."
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/powershell
          echo "Disk space freed."

      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Ruff
        run: pip install ruff==0.15.0

      - name: Run Ruff Linter (GitHub annotations)
        run: ruff check src/ --output-format=github
        continue-on-error: true  # Keep running so SARIF step always executes

      - name: Generate Ruff SARIF Report
        if: always()
        run: ruff check src/ --output-format=sarif --output-file=ruff-results.sarif || true

      - name: Upload Ruff SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('ruff-results.sarif') != ''
        with:
          sarif_file: ruff-results.sarif
          category: ruff-lint

      - name: Run Ruff Formatter Check
        if: always()
        run: ruff format src/ --check --diff
        continue-on-error: true

  # ============================================================
  # TEST JOB - Matrix testing across Python versions
  # ============================================================
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    if: ${{ false }}  # Tests temporarily disabled
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src/warden_rust
          shared-key: "rust-py${{ matrix.python-version }}"

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install ".[dev]"

      - name: Run Tests
        run: |
          # Test exclusions (VALID for CI):
          # --ignore=tests/chaos/ - Requires Hypothesis (optional dependency)
          # --ignore=tests/integration/ - Requires external services (Ollama, APIs)
          # --ignore=tests/e2e/test_acceptance.py - Subprocess tests with different Ollama setup
          # -m "not requires_ollama" - Skip tests needing local Ollama
          pytest tests/ -v --tb=short -x \
            --ignore=tests/chaos/ \
            --ignore=tests/integration/ \
            --ignore=tests/e2e/test_acceptance.py \
            -m "not requires_ollama" \
            -q

  # ============================================================
  # WARDEN SCAN JOB - Security analysis
  # ============================================================
  warden-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [lint]
    if: always() && needs.lint.result != 'cancelled'
    timeout-minutes: ${{ github.event_name == 'workflow_dispatch' && 360 || 120 }}

    steps:
      - name: Free Disk Space (Manual)
        run: |
          echo "Freeing disk space..."
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/powershell
          echo "Disk space freed."

      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'pyproject.toml'

      # Rust is pre-installed on ubuntu-latest. We only cache the artifacts.
      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src/warden_rust
          shared-key: "rust-warden-scan"

      - name: Install Warden
        run: |
          pip install --upgrade pip
          pip install ".[semantic]"
          # Verify installation
          warden --help

      - name: Cache Warden Storage
        uses: actions/cache@v5
        with:
          path: |
            .warden/memory
            .warden/embeddings
          key: warden-storage-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            warden-storage-${{ runner.os }}-

      - name: Cache Warden Triage & Findings
        uses: actions/cache@v5
        with:
          path: .warden/cache/
          key: warden-cache-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            warden-cache-${{ runner.os }}-

      - name: Cache AI Models
        uses: actions/cache@v5
        with:
          path: ~/.ollama
          key: ollama-models-${{ runner.os }}-${{ hashFiles('.warden/config.yaml') }}
          restore-keys: |
            ollama-models-${{ runner.os }}-

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Cache Baseline Report
        id: baseline-cache
        uses: actions/cache@v5
        with:
          path: .warden/baseline.sarif
          key: warden-baseline-${{ github.ref_name }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            warden-baseline-${{ github.ref_name }}-
            warden-baseline-main-

      # Verify Code Intelligence disabled in CI: warden refresh --force runs
      # tree-sitter AST analysis on all 557 files before Ollama is ready,
      # adding 10-20 min of overhead for no benefit in incremental scan mode.
      # - name: Verify Code Intelligence (Audit Context)


      - name: Start Ollama
        env:
          # Server-side vars must be in the *serve* process environment,
          # not the scan step ‚Äî Ollama reads these from its own process via os.Getenv().
          OLLAMA_MAX_LOADED_MODELS: "1"
          OLLAMA_FLASH_ATTENTION: "1"
          OLLAMA_CONTEXT_LENGTH: "2048"
        run: |
          curl -fsSL -o /tmp/ollama-install.sh https://ollama.com/install.sh
          bash /tmp/ollama-install.sh && rm /tmp/ollama-install.sh
          sudo systemctl stop ollama || true
          sudo systemctl disable ollama || true
          # If systemctl stop failed silently the port may still be bound; kill any
          # leftover ollama process before starting a fresh server.
          lsof -ti :11434 | xargs --no-run-if-empty sudo kill -9 || true
          ollama serve &
          for i in {1..30}; do curl -s http://localhost:11434/api/tags > /dev/null && break || sleep 1; done
          if ollama list | grep -q "qwen2.5-coder:3b"; then
            echo "‚úÖ Model already cached."
          else
            ollama pull qwen2.5-coder:3b
          fi
          curl -s http://localhost:11434/api/generate \
            -d '{"model":"qwen2.5-coder:3b","prompt":"","keep_alive":-1}' -o /dev/null
          echo "‚úÖ Ollama ready."

      - name: Run Warden Scan
        env:
          BASE_REF: ${{ github.base_ref || 'main' }}
          WARDEN_LLM_PROVIDER: "ollama"
          WARDEN_BLOCKED_PROVIDERS: "claude_code,codex"
          OLLAMA_HOST: http://localhost:11434
        run: |
          # =============================================================
          # SCAN STRATEGY (both paths use Ollama)
          # - push/PR : --level standard on changed Python files only
          # - workflow_dispatch: --level standard on full src/warden/
          # =============================================================

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # --- FULL SCAN (manual trigger) ---
            echo "Manual dispatch ‚Äî running full LLM scan on src/warden/ ..."
            set +e
            warden scan src/warden --level standard --ci --format sarif --output warden.sarif
            EXIT_CODE=$?
            set -e
            if [ $EXIT_CODE -eq 2 ]; then
              echo "::error title=Policy Violation::Critical issues found. Review SARIF."
              exit 1
            elif [ $EXIT_CODE -ne 0 ]; then
              echo "::warning title=Scan Incomplete::Scan failed (infrastructure). Quality gate skipped."
              echo "‚ö†Ô∏è Scan exit $EXIT_CODE ‚Äî infrastructure issue, not a code quality failure."
            else
              echo "‚úÖ Full scan passed."
            fi
            if [ -f warden.sarif ]; then
              mkdir -p .warden && cp warden.sarif .warden/baseline.sarif
              echo "üì¶ Baseline saved."
            fi

          else
            # --- INCREMENTAL SCAN (push / PR) ---
            # Ollama already running. Scan only changed Python files.
            git fetch origin "$BASE_REF" --depth=1 2>/dev/null || true

            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              CHANGED_FILES=$(git diff --name-only --diff-filter=d "origin/$BASE_REF"...HEAD 2>/dev/null | grep "\.py$" || true)
            else
              CHANGED_FILES=$(git diff --name-only --diff-filter=d HEAD~1 HEAD 2>/dev/null | grep "\.py$" || \
                              git diff --name-only --diff-filter=d "origin/$BASE_REF"...HEAD 2>/dev/null | grep "\.py$" || true)
            fi

            if [ -n "$CHANGED_FILES" ]; then
              CHANGED_FILES=$(echo "$CHANGED_FILES" | while read f; do [ -f "$f" ] && echo "$f"; done || true)
            fi

            FILE_COUNT=$(echo "$CHANGED_FILES" | grep -c . || echo 0)
            echo "Changed Python files ($FILE_COUNT):"
            echo "$CHANGED_FILES"

            if [[ -z "$CHANGED_FILES" ]]; then
              echo "‚úÖ No Python files changed. Skipping scan."
              exit 0
            fi

            set +e
            FILES=$(echo "$CHANGED_FILES" | tr '\n' ' ')
            warden scan $FILES --level standard --ci --format sarif --output warden.sarif
            EXIT_CODE=$?
            set -e

            if [ $EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Incremental LLM scan passed."
            elif [ $EXIT_CODE -eq 2 ]; then
              echo "üö´ CRITICAL ISSUES FOUND"
              echo "::error title=Policy Violation::Critical issues found in changed files. Review SARIF."
              exit 1
            else
              echo "::warning title=Scan Incomplete::Scan failed (infrastructure). Quality gate skipped."
              echo "‚ö†Ô∏è Scan exit $EXIT_CODE ‚Äî not a code quality violation."
            fi
          fi

      - name: Archive SARIF Artifact
        uses: actions/upload-artifact@v6
        if: always() && hashFiles('warden.sarif') != ''
        with:
          name: warden-scan-results
          path: warden.sarif

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always() && github.event_name != 'pull_request' && hashFiles('warden.sarif') != ''
        with:
          sarif_file: warden.sarif
          category: warden-security

  # ============================================================
  # RELEASE SMOKE - Fast verification on release tags
  # ============================================================
  release-smoke:
    name: Release Smoke (fast)
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [lint]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dev Dependencies
        run: |
          pip install --upgrade pip
          pip install .[dev]

      - name: Pytest Smoke (minimal)
        env:
          WARDEN_NON_INTERACTIVE: "true"
          CORS_ORIGINS: "[]"
        run: |
          pytest -q -x \
            tests/e2e/test_cli_commands.py::TestGlobalCLI::test_help \
            tests/e2e/test_init_flows.py::TestInitFileCreation::test_init_creates_config_yaml \
            tests/e2e/test_llm_cli.py::test_init_help_shows_new_flags \
            tests/e2e/test_llm_cli.py::test_config_llm_help_and_status
