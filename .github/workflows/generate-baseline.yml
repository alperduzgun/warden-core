name: Generate Warden Baseline

on:
  schedule:
    - cron: '0 0 * * *'  # Run nightly at midnight UTC to prevent drift
  workflow_dispatch:
    inputs:
      level:
        description: 'Scan Level'
        required: true
        default: 'deep'
        type: choice
        options:
        - standard
        - deep
      concurrency:
        description: 'Concurrency Limit (Default: 10 for safe Azure usage)'
        required: true
        default: '10'
        type: string

concurrency:
  group: baseline-generation
  cancel-in-progress: false

jobs:
  baseline:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 360
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Cache Warden Storage
      uses: actions/cache@v5
      with:
        path: |
          .warden/memory
          .warden/embeddings
        key: warden-storage-${{ runner.os }}-${{ github.sha }}
        restore-keys: |
          warden-storage-${{ runner.os }}-

    - name: Cache AI Models
      uses: actions/cache@v5
      with:
        path: ~/.ollama
        key: ollama-models-${{ runner.os }}-${{ hashFiles('.warden/config.yaml') }}
        restore-keys: |
          ollama-models-${{ runner.os }}-
        
    - name: Install Dependencies
      run: |
        pip install -e .
        pip install structlog
        
    - name: Install and Start Ollama
      run: |
        # Download and verify before executing
        curl -fsSL -o /tmp/ollama-install.sh https://ollama.com/install.sh
        bash /tmp/ollama-install.sh
        rm /tmp/ollama-install.sh
        ollama serve &
        echo "Waiting for Ollama to be ready..."
        for i in {1..30}; do
          if curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
            echo "Ollama is ready!"
            break
          fi
          echo "Attempt $i/30: Ollama not ready yet..."
          sleep 1
        done
        if ! curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
          echo "::warning::Ollama failed to start, continuing without local LLM"
        fi
        
    - name: Pull Local Model (Fast Tier Backup)
      run: |
        # Use a tiny model for CI fallback to handle Rate Limits without cost
        # With caching, this will be instant on subsequent runs
        ollama pull qwen2.5-coder:0.5b
        
    - name: Run Warden Scan
      env:
        # STRATEGY: 
        # 1. Fast Tier (Primary): Groq (LPU Speed, Cloud)
        # 2. Fast Tier (Fallback): Ollama (Local CPU, Free, Handles Rate Limits)
        # 3. Smart Tier: Azure OpenAI (High Cost, Only for complex reasoning)
        AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
        AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        
        # Enforce Optimized Chain
        WARDEN_LLM_PROVIDER: "azure_openai"      # Smart Tier (Last Resort)
        WARDEN_FAST_TIER_PRIORITY: "groq,ollama" # Fast Tier: Groq -> Ollama
        WARDEN_LLM_CONCURRENCY: ${{ inputs.concurrency || '10' }}
      run: |
        # Use input values or defaults for scheduled runs
        SCAN_LEVEL="${{ inputs.level }}"
        SCAN_LEVEL="${SCAN_LEVEL:-deep}"

        echo "Running Baseline Scan with: Level=${SCAN_LEVEL}"
        echo "Strategy: Groq (Primary) -> Ollama (Backup) -> Azure (Complex)"

        # Run scan and ensure baseline.sarif is generated/updated
        # --update-baseline updates module-based debt tracking in .warden/baseline/
        warden scan --level ${SCAN_LEVEL} --format sarif --output .warden/baseline.sarif --update-baseline

        # Verify baseline exists
        if [ ! -f .warden/baseline.sarif ]; then
            echo "Error: baseline.sarif not found!"
            exit 1
        fi

    - name: Commit Baseline
      run: |
        git config --global user.name "Warden Bot"
        git config --global user.email "bot@warden.ai"
        # Add SARIF report (always exists after scan)
        git add .warden/baseline.sarif
        # Add module-based baseline directory if it exists
        if [ -d ".warden/baseline" ]; then
          git add .warden/baseline/
        fi
        git commit -m "chore: update warden baseline [skip ci]" || echo "No changes to baseline"
        git push
